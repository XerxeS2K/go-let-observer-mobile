name: Apply Android touch build

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  apply_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply Android entrypoint
        run: |
          set -e
          APPDIR="cmd/go-let-observer"

          # Ensure directory exists
          test -d "$APPDIR"

          # Add build tag to desktop main.go
          if ! grep -q "go:build !android" "$APPDIR/main.go"; then
            tmp=$(mktemp)
            printf "%s\n" \
              "//go:build !android" \
              "// +build !android" \
              "" \
              "$(cat "$APPDIR/main.go")" > "$tmp"
            mv "$tmp" "$APPDIR/main.go"
          fi

          # Write Android main file safely (no heredoc)
          printf "%s\n" \
            "//go:build android" \
            "// +build android" \
            "" \
            "package main" \
            "" \
            "import (" \
            "  \"log\"" \
            "  \"golang.org/x/mobile/app\"" \
            "  \"github.com/hajimehoshi/ebiten/v2/mobile\"" \
            ")" \
            "" \
            "func main() {" \
            "  log.Println(\"go-let-observer Android starting\")" \
            "  app.Main(func(a app.App) {" \
            "    mobile.SetGame(NewAndroidApp())" \
            "  })" \
            "}" \
            > "$APPDIR/main_android.go"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Android entrypoint for gomobile" || true
          git push

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --licenses
          sdkmanager "ndk;26.3.11579264"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.3.11579264" >> $GITHUB_ENV

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init

      - name: Build APK
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          gomobile build -v -androidapi 21 -target=android \
            -o /tmp/go-let-observer-debug.apk \
            ./cmd/go-let-observer

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: go-let-observer-debug-apk
          path: /tmp/go-let-observer-debug.apk
